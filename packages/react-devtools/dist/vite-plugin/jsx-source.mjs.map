{"version":3,"sources":["../../src/vite-plugin/jsx-source.ts"],"sourcesContent":["import type { Plugin, TransformResult } from 'vite';\nimport MagicString from 'magic-string';\n\nexport interface VdevPluginOptions {\n    /** Prefix for the data attribute (default: 'vdev') */\n    prefix?: string;\n    /** File patterns to exclude */\n    exclude?: RegExp[];\n}\n\n/**\n * Vite plugin to inject source location data attributes into JSX elements.\n * This enables the Visual Dev Tool to locate source code from rendered elements.\n * \n * Works with @vitejs/plugin-react-swc for stable HMR support.\n */\nexport function vdevJsxSource(options: VdevPluginOptions = {}): Plugin {\n    const prefix = options.prefix || 'vdev';\n    const exclude = options.exclude || [/node_modules/];\n\n    return {\n        name: 'vdev-jsx-source',\n        // Use 'post' to run after other transforms, avoiding HMR issues\n        enforce: 'post',\n\n        transform(code: string, id: string): TransformResult | null {\n            // Skip excluded files\n            if (exclude.some(pattern => pattern.test(id))) {\n                return null;\n            }\n\n            // Only process JSX/TSX files\n            if (!/\\.[jt]sx$/.test(id)) {\n                return null;\n            }\n\n            // Skip if no JSX-like patterns (quick check)\n            if (!code.includes('jsx(') && !code.includes('jsxs(') && !code.includes('jsxDEV(')) {\n                return null;\n            }\n\n            // After SWC transform, JSX becomes function calls like:\n            // jsx(\"div\", { ... }) or jsxDEV(\"div\", { ... }, ...)\n            // We inject our data attributes into the props object\n\n            const magicString = new MagicString(code);\n            let modified = false;\n\n            // Match jsx/jsxs/jsxDEV function calls\n            // Pattern: jsx(\"tagName\", { props })  or  jsx(Component, { props })\n            const jsxCallRegex = /\\b(jsx|jsxs|jsxDEV)\\s*\\(\\s*(?:\"([^\"]+)\"|'([^']+)'|([A-Z][a-zA-Z0-9_$.]*)|([a-z][a-zA-Z0-9_]*))\\s*,\\s*\\{/g;\n\n            // Track line numbers for source location\n            const lines = code.split('\\n');\n            const getLineCol = (index: number) => {\n                let line = 1;\n                let lastNewline = -1;\n                for (let i = 0; i < index && i < code.length; i++) {\n                    if (code[i] === '\\n') {\n                        line++;\n                        lastNewline = i;\n                    }\n                }\n                return { line, col: index - lastNewline - 1 };\n            };\n\n            let match;\n            while ((match = jsxCallRegex.exec(code)) !== null) {\n                const openBraceIndex = match.index + match[0].length - 1;\n                const { line, col } = getLineCol(match.index);\n\n                // Check if already has our data attribute\n                const nextChars = code.slice(openBraceIndex + 1, openBraceIndex + 100);\n                if (nextChars.includes(`\"data-${prefix}-file\"`)) {\n                    continue;\n                }\n\n                // Inject data attributes as first properties\n                const injection = `\"data-${prefix}-file\": \"${id}\", \"data-${prefix}-line\": \"${line}\", \"data-${prefix}-col\": \"${col}\", `;\n\n                magicString.appendLeft(openBraceIndex + 1, injection);\n                modified = true;\n            }\n\n            if (!modified) {\n                return null;\n            }\n\n            return {\n                code: magicString.toString(),\n                map: magicString.generateMap({ hires: true })\n            };\n        }\n    };\n}\n\nexport default vdevJsxSource;\n"],"mappings":";AACA,OAAO,iBAAiB;AAejB,SAAS,cAAc,UAA6B,CAAC,GAAW;AACnE,QAAM,SAAS,QAAQ,UAAU;AACjC,QAAM,UAAU,QAAQ,WAAW,CAAC,cAAc;AAElD,SAAO;AAAA,IACH,MAAM;AAAA;AAAA,IAEN,SAAS;AAAA,IAET,UAAU,MAAc,IAAoC;AAExD,UAAI,QAAQ,KAAK,aAAW,QAAQ,KAAK,EAAE,CAAC,GAAG;AAC3C,eAAO;AAAA,MACX;AAGA,UAAI,CAAC,YAAY,KAAK,EAAE,GAAG;AACvB,eAAO;AAAA,MACX;AAGA,UAAI,CAAC,KAAK,SAAS,MAAM,KAAK,CAAC,KAAK,SAAS,OAAO,KAAK,CAAC,KAAK,SAAS,SAAS,GAAG;AAChF,eAAO;AAAA,MACX;AAMA,YAAM,cAAc,IAAI,YAAY,IAAI;AACxC,UAAI,WAAW;AAIf,YAAM,eAAe;AAGrB,YAAM,QAAQ,KAAK,MAAM,IAAI;AAC7B,YAAM,aAAa,CAAC,UAAkB;AAClC,YAAI,OAAO;AACX,YAAI,cAAc;AAClB,iBAAS,IAAI,GAAG,IAAI,SAAS,IAAI,KAAK,QAAQ,KAAK;AAC/C,cAAI,KAAK,CAAC,MAAM,MAAM;AAClB;AACA,0BAAc;AAAA,UAClB;AAAA,QACJ;AACA,eAAO,EAAE,MAAM,KAAK,QAAQ,cAAc,EAAE;AAAA,MAChD;AAEA,UAAI;AACJ,cAAQ,QAAQ,aAAa,KAAK,IAAI,OAAO,MAAM;AAC/C,cAAM,iBAAiB,MAAM,QAAQ,MAAM,CAAC,EAAE,SAAS;AACvD,cAAM,EAAE,MAAM,IAAI,IAAI,WAAW,MAAM,KAAK;AAG5C,cAAM,YAAY,KAAK,MAAM,iBAAiB,GAAG,iBAAiB,GAAG;AACrE,YAAI,UAAU,SAAS,SAAS,MAAM,QAAQ,GAAG;AAC7C;AAAA,QACJ;AAGA,cAAM,YAAY,SAAS,MAAM,YAAY,EAAE,YAAY,MAAM,YAAY,IAAI,YAAY,MAAM,WAAW,GAAG;AAEjH,oBAAY,WAAW,iBAAiB,GAAG,SAAS;AACpD,mBAAW;AAAA,MACf;AAEA,UAAI,CAAC,UAAU;AACX,eAAO;AAAA,MACX;AAEA,aAAO;AAAA,QACH,MAAM,YAAY,SAAS;AAAA,QAC3B,KAAK,YAAY,YAAY,EAAE,OAAO,KAAK,CAAC;AAAA,MAChD;AAAA,IACJ;AAAA,EACJ;AACJ;AAEA,IAAO,qBAAQ;","names":[]}